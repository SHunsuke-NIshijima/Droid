# 日本語エンコーディング問題の修正レポート

## 問題

Windows Forms GUIで日本語ファイル名やパスを含むprompt.jsonを読み込むと文字化けエラーが発生していました。

## 原因

PowerShellの`Out-File -Encoding UTF8`コマンドは、デフォルトで**UTF-8 with BOM**（Byte Order Mark付き）でファイルを保存します。これにより：

1. BOMが原因でJSON解析エラーが発生する可能性
2. 日本語文字が正しくエンコードされない場合がある
3. 一部のツールでBOM付きUTF-8が正しく処理されない

## 修正内容

### 1. エンコーディング設定の追加

スクリプトの冒頭に以下を追加：

```powershell
# 文字エンコーディング設定（日本語対応）
[Console]::OutputEncoding = [System.Text.Encoding]::UTF8
$OutputEncoding = [System.Text.Encoding]::UTF8
[System.Console]::InputEncoding = [System.Text.Encoding]::UTF8
```

**効果**:
- コンソール出力が正しくUTF-8で処理される
- PowerShellスクリプト全体でUTF-8エンコーディングが保証される

### 2. UTF-8 without BOMでの保存

`Save-Settings`関数を修正：

```powershell
# 修正前
$json | Out-File -FilePath $PromptFile -Encoding UTF8

# 修正後
$utf8NoBom = New-Object System.Text.UTF8Encoding($false)
[System.IO.File]::WriteAllText($PromptFile, $json, $utf8NoBom)
```

**効果**:
- BOMなしのUTF-8で保存
- JSON標準に準拠
- 文字化けを完全に防止

### 3. 読み込み処理の改善

`Load-Settings`関数を修正：

```powershell
# 修正前
$data = Get-Content -Path $PromptFile -Raw -Encoding UTF8 | ConvertFrom-Json

# 修正後
$jsonContent = [System.IO.File]::ReadAllText($PromptFile, [System.Text.Encoding]::UTF8)
$data = $jsonContent | ConvertFrom-Json
```

**効果**:
- BOM有無に関わらず正しく読み込み
- より確実なUTF-8デコード
- ファイルシステムAPIを直接使用

## テスト

### テストスクリプト: `test_encoding.ps1`

日本語文字を含む包括的なテストを実施：

```powershell
# テストデータ
$testData = @{
    prompt = "このコードをレビューして改善点を教えてください。日本語テスト：漢字、ひらがな、カタカナ"
    options = @{
        working_directory = ".\テスト\フォルダ"
        log_directory = "ログ"
        agents_file = "C:\プロジェクト\AGENTS.md"
        ref_filepath = @(
            ".\サンプル\データ.xlsx"
            ".\資料\ドキュメント.txt"
        )
    }
}
```

### テスト結果

```
=== DROID GUI エンコーディングテスト ===

1. UTF-8 (BOMなし) で保存テスト...
   ✓ 保存成功

2. UTF-8で読み込みテスト...
   ✓ 読み込み成功

3. 日本語文字の整合性チェック...
   ✓ 全ての日本語文字が正しく保存・読み込みされました

4. 保存されたJSONの内容確認...
{
  "prompt": "このコードをレビューして改善点を教えてください。日本語テスト：漢字、ひらがな、カタカナ",
  "options": {
    "working_directory": ".\\テスト\\フォルダ",
    "log_directory": "ログ",
    "agents_file": "C:\\プロジェクト\\AGENTS.md",
    "ref_filepath": [
      ".\\サンプル\\データ.xlsx",
      ".\\資料\\ドキュメント.txt"
    ]
  }
}

5. ファイルのBOMチェック...
   ✓ BOMなし（UTF-8 without BOM）

=== テスト完了 ===
全てのテストが成功しました！
```

## 対応する日本語文字

### 完全対応
- ✅ 漢字
- ✅ ひらがな
- ✅ カタカナ
- ✅ 全角記号
- ✅ 日本語パス: `.\テスト\フォルダ`
- ✅ 日本語ファイル名: `データ.xlsx`, `ドキュメント.txt`
- ✅ 日本語プロンプト
- ✅ 日本語ディレクトリ名

### 使用例

#### prompt.json（日本語対応版）
```json
{
  "prompt": "このプロジェクトのコードをレビューして、改善点を日本語で教えてください。",
  "options": {
    "working_directory": "C:\\ユーザー\\プロジェクト\\開発",
    "model": "claude-sonnet-4-20250514",
    "auto_level": "medium",
    "log_directory": "実行ログ",
    "agents_file": "C:\\設定\\カスタムエージェント\\AGENTS.md",
    "ref_filepath": [
      ".\\サンプルデータ\\入力.xlsx",
      ".\\資料\\仕様書.docx",
      ".\\ソースコード\\メイン.py"
    ]
  }
}
```

## 技術詳細

### UTF-8 with BOM vs UTF-8 without BOM

| 項目 | UTF-8 with BOM | UTF-8 without BOM |
|------|----------------|-------------------|
| **BOM** | EF BB BF | なし |
| **JSONサポート** | ⚠️ 一部問題あり | ✅ 完全対応 |
| **PowerShell Out-File** | デフォルト | 要カスタム |
| **標準準拠** | 非推奨 | 推奨 |
| **互換性** | 低い | 高い |

### .NET Frameworkメソッド使用

```powershell
# UTF-8 without BOMエンコーダーの作成
$utf8NoBom = New-Object System.Text.UTF8Encoding($false)
# $false = BOMなし

# ファイル書き込み
[System.IO.File]::WriteAllText($path, $content, $utf8NoBom)

# ファイル読み込み
$content = [System.IO.File]::ReadAllText($path, [System.Text.Encoding]::UTF8)
```

**利点**:
- 直接ファイルシステムAPIを使用
- エンコーディングの完全な制御
- BOM有無を明示的に指定可能

## 影響範囲

### 修正されたファイル
- `gui_droid_winforms.ps1`
  - Load-Settings関数
  - Save-Settings関数
  - スクリプト初期化部分

### 新規追加ファイル
- `test_encoding.ps1` - エンコーディングテストスクリプト

### 影響を受ける機能
- ✅ prompt.jsonの読み込み
- ✅ prompt.jsonの保存
- ✅ 日本語パスの処理
- ✅ 日本語ファイル名の処理
- ✅ AGENTS.mdパスの処理

## 後方互換性

### ✅ 完全に維持
- 既存のprompt.json（BOM付き/なし両方）を正しく読み込み
- 新規保存は常にUTF-8 without BOM
- 既存の英語のみのファイルにも影響なし

## 検証方法

ユーザーが日本語エンコーディングを確認する方法：

```powershell
# 1. GUIで日本語を含む設定を保存
#    プロンプト: "このコードをレビューしてください"
#    AGENTS.md: "C:\プロジェクト\AGENTS.md"

# 2. 保存されたファイルを確認
Get-Content prompt.json -Encoding UTF8

# 3. BOMの有無を確認
$bytes = [System.IO.File]::ReadAllBytes("prompt.json")
if ($bytes[0] -eq 0xEF -and $bytes[1] -eq 0xBB -and $bytes[2] -eq 0xBF) {
    Write-Host "BOM付き"
} else {
    Write-Host "BOMなし（正常）"
}

# 4. エンコーディングテストを実行
pwsh -File test_encoding.ps1
```

## まとめ

### 修正前の問題
- ❌ 日本語ファイル名で文字化け
- ❌ UTF-8 with BOMが原因のJSON解析エラー
- ❌ 一部のツールとの非互換性

### 修正後の状態
- ✅ 日本語完全対応
- ✅ UTF-8 without BOM（JSON標準準拠）
- ✅ 高い互換性
- ✅ 包括的なテストで検証済み

### テスト結果
- ✅ 全てのテストをパス
- ✅ 漢字・ひらがな・カタカナの整合性確認
- ✅ UTF-8 BOMなし確認
- ✅ 日本語パス・ファイル名の動作確認

---

**コミット**: 3de544f
**ステータス**: ✅ 修正完了・検証済み
**影響**: 日本語ユーザーの文字化け問題を完全解決
